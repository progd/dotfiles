" vim: set ft=vimperator:

" prefs
" ======================================================================
" ダウンロードマネージャを表示しない
set! browser.download.manager.showWhenStarting=false

" 最後のタブを閉じたときに Firefox を終了しない
set! browser.tabs.closeWindowWithLastTab=false

"ページのアクセスキーを無効化
set! ui.key.contentAccess=0

" ポップアップ許可数を拡張 cf.http://la.ma.la/blog/diary_200611171115.htm
set! dom.popup_maximum=9999

" 自動アップデート無効
set! app.update.auto=false

" 新規タブをバックグラウンドで開く
set! browser.tabs.loadDivertedInBackground=true

" ヒントに使用する文字
set hintchars="abcdefghijklmnopqrstuvwxyz"
" GUI 表示設定: タブのみ表示
set toolbars=noaddons,nobookmarks,nomenu,nonavigation,tabs
" タブに番号を表示
set tabnumbers

set! general.smoothScroll=false

" ヒントのスタイル
highlight Hint font-family: "Bitstream Vera Sans Mono",monaco,monospace; font-size: 14px; font-weight: bold; color: white; background-color: green; border-color: ButtonShadow; border-width: 0px; border-style: solid; padding: 2px; line-height: 1em;

" アドオン: ツリー型タブでインデントしない
set! extensions.treestyletab.maxTreeLevel.vertical=0

" mappings
" ======================================================================

" j/k のスクロール幅を変更
noremap j 10j
noremap k 10k

" l/h でタブ移動
noremap l gt
noremap h gT

" C-l/h で進む/戻る
noremap <C-l> :forward<CR>
noremap <C-h> :back<CR>
noremap <BS> :back<CR>

" 文字入力時に emacs っぽいキーバインド
noremap  <C-g> <esc>
inoremap <C-g> <esc>
cnoremap <C-g> <esc>
inoremap <C-p> <up>
cnoremap <C-p> <up>
inoremap <C-n> <down>
cnoremap <C-n> <down>
inoremap <C-f> <right>
cnoremap <C-f> <right>
inoremap <A-f> <C-right>
cnoremap <A-f> <C-right>
inoremap <C-b> <left>
cnoremap <C-b> <left>
inoremap <A-b> <C-left>
cnoremap <A-b> <C-left>
inoremap <C-m> <CR>
cnoremap <C-m> <CR>
inoremap <C-j> <CR>
cnoremap <C-j> <CR>
inoremap <A-d> <C-del>

" zoom in/out を text zoom でなく full zoom にする
nnoremap zz zZ
nnoremap zi zI
nnoremap zo zO

let mapleader = ','
nnoremap <leader>t :tabopen google<space>
nnoremap <leader>o :open google<space>

nnoremap <leader>v :open javascript:location.href='http://b.hatena.ne.jp/entry/'+location.href<CR>

" ブックマークレット
qmark i javascript:location.href='http://www.instapaper.com/m?u='+escape(location.href);
qmark l javascript:location.href='http://reader.livedoor.com/subscribe/'+location.href
qmark f javascript:void(window.open('http://fullrss.net/analyze/?url='+encodeURIComponent(location.href),'_blank'))
qmark a javascript:function%20iprl5(){var%20d=document,z=d.createElement('scr'+'ipt'),b=d.body,l=d.location;try{if(!b)throw(0);d.title='(Saving...)%20'+d.title;z.setAttribute('src',l.protocol+'//www.instapaper.com/j/Nm52Rs2w20Hx?u='+encodeURIComponent(l.href)+'&t='+(new%20Date().getTime()));b.appendChild(z);}catch(e){alert('Please%20wait%20until%20the%20page%20has%20loaded.');}}iprl5();void(0)

" ex mode時IMEをOFF
style -name commandline-ime chrome://* #liberator-commandline-command input { ime-mode: inactive; }

" autocmd 駆動時のエコーをやめる https://gist.github.com/anekos/1028562
js <<EOM
let (original = liberator.echomsg)
  liberator.echomsg = function (msg) {
    const REAC = RegExp('@chrome://liberator/content/autocommands\\.js:\\d+');
    if (Error().stack.split(/\n/).some(RegExp.prototype.test.bind(REAC)) && /Executing .* Auto commands for .*/.test(msg))
      liberator.log(msg);
    else
      original.apply(liberator, arguments);
  };
EOM

" addons
" ツリー型タブ
set! extensions.treestyletab.allowSubtreeCollapseExpand.vertical=false

" command
" ======================================================================
" autocmd VimperatorEnter .* <args> を lazy コマンドとして登録
command! -nargs=+ lazy autocmd VimperatorEnter .* <args>

" plugins
" ======================================================================

" load_plugin.js
let g:plugin_loader_roots = "~/projects/vimperator-plugins/"
let g:plugin_loader_plugins = "_libly,pluginManager,walk-input,feedSomeKeys_3,stella"

" feedSomKeys_3.js webservice 最適化
lazy fmaps -u='^http://reader\.livedoor\.com/reader/' j k s a p v z <S-z> ,r,r < > o,vj <Space> <S-Space> c
lazy fmaps -u='^https?://mail\.google\.com/(mail|a)/' c j k n p o u e x s r a y # [ ] z ? gi gs gt gd ga gc
lazy fmaps -u='^https?://soundcloud\.com/' <Space> <CR> s m <Left> <Right> <S-Left> <S-Right> <S-Up> <S-Down> 0 1 2 3 4 5 6 7 8 9

" stella.js
js <<EOM
function addLocalMappings(buffer, maps) {
  maps.forEach(
    function (map) {
      let [cmd, action, extra] = map;
      let actionFunc = action;
      extra || (extra = {});

      if (typeof action == "string") {
        if (action.charAt(0) == ':')
          actionFunc = extra.open ? function () commandline.open("", action, modes.EX)
                                  : function () liberator.execute(action);
        else
          actionFunc = function () events.feedkeys(action, extra.noremap, true);
      }
      extra.matchingUrls = buffer;
      mappings.addUserMap(
        [modes.NORMAL],
        [cmd],
        "Local mapping for " + buffer,
        actionFunc,
        extra
      );
    }
  );
}
addLocalMappings(
  /^(http:\/\/(es|www).nicovideo.jp\/(watch|playlist\/mylist)|http:\/\/(jp|www)\.youtube\.com\/watch|http:\/\/(www\.)?vimeo\.com\/(channels\/(hd)?#)?\d+)/,
  [
    ['<C-g>', ':pageinfo S', ],
    ['p', ':stplay', ],
    ['m', ':stmute', ],
    [',c', ':stcomment', ],
    ['zz', ':stlarge', ],
    ['r', ':strepeat', ],
    ['^', ':stvolume! 10', ],
    ['-', ':stvolume! -10', ],
    ['<', ':stseek! -10', ],
    ['>', ':stseek! 10', ],
    ['v', ':stvolume ', {open: true}],
    ['V', ':stvolume! ', {open: true}],
  ]
);
EOM

